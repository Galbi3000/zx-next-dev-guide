\newcommand*{\PRINTED}{}	% comment this line for generating online variant

% ░█▀▀█ ▒█▀▀█ ▒█▀▀▀█ ▒█░▒█ ▀▀█▀▀ 
% ▒█▄▄█ ▒█▀▀▄ ▒█░░▒█ ▒█░▒█ ░▒█░░ 
% ▒█░▒█ ▒█▄▄█ ▒█▄▄▄█ ░▀▄▄▀ ░▒█░░

% general document info for simpler reuse
\newcommand{\AuthorName}{Toma\v{z}}
\newcommand{\AuthorNameSurname}{\AuthorName ~Kragelj}
\newcommand{\BookTitleMain}{ZX Spectrum Next}
\newcommand{\BookTitleSub}{Assembly Developer Guide}
\newcommand{\BookTitle}{\BookTitleMain~\BookTitleSub}


% ▒█▀▀█ ▒█▀▀▀ ▒█░░▒█ ▀█▀ ▒█▀▀▀█ ▀█▀ ▒█▀▀▀█ ▒█▄░▒█ ▒█▀▀▀█ 
% ▒█▄▄▀ ▒█▀▀▀ ░▒█▒█░ ▒█░ ░▀▀▀▄▄ ▒█░ ▒█░░▒█ ▒█▒█▒█ ░▀▀▀▄▄ 
% ▒█░▒█ ▒█▄▄▄ ░░▀▄▀░ ▄█▄ ▒█▄▄▄█ ▄█▄ ▒█▄▄▄█ ▒█░░▀█ ▒█▄▄▄█

\newcommand{\LatestYear}{2021}
\newcommand{\LatestMonthName}{September}
\newcommand{\LatestMonth}{09}
\newcommand{\LatestDay}{15}

% revision name is nicely structured variant with named month
\newcommand{\LatestRevisionName}{\LatestDay~\LatestMonthName~\LatestYear}

% revision date is "reverse domain" type that can be easily sorted in various computer lists; also suitable for git tags
\newcommand{\LatestRevisionDate}{\LatestYear-\LatestMonth-\LatestDay}


% ▒█▀▀▀ ▒█░░░ ▒█▀▀▀ ▒█▀▄▀█ ▒█▀▀▀ ▒█▄░▒█ ▀▀█▀▀ ▒█▀▀▀█ 
% ▒█▀▀▀ ▒█░░░ ▒█▀▀▀ ▒█▒█▒█ ▒█▀▀▀ ▒█▒█▒█ ░▒█░░ ░▀▀▀▄▄ 
% ▒█▄▄▄ ▒█▄▄█ ▒█▄▄▄ ▒█░░▒█ ▒█▄▄▄ ▒█░░▀█ ░▒█░░ ▒█▄▄▄█

% definitions based on whether PDF is generated for book or online.
\newcommand{\email}[3]{\ifdefined\PRINTED{\tt #1@#2.#3}\else{\tt #1 AT #2 DOT #3}\fi}


% ▒█▀▀█ ▒█▀▀▀█ ▒█░░░ ▒█▀▀▀█ ▒█░▒█ ▒█▀▀█ ▒█▀▀▀█ 
% ▒█░░░ ▒█░░▒█ ▒█░░░ ▒█░░▒█ ▒█░▒█ ▒█▄▄▀ ░▀▀▀▄▄ 
% ▒█▄▄█ ▒█▄▄▄█ ▒█▄▄█ ▒█▄▄▄█ ░▀▄▄▀ ▒█░▒█ ▒█▄▄▄█

\definecolor{PrintableLightGray}{rgb}{0.85, 0.85, 0.85}
\definecolor{PrintableDarkGray}{rgb}{0.5, 0.5, 0.5}


% ▒█▀▀█ ░█▀▀█ ▒█▀▀█ ▒█▀▀▀ 　 ▒█▀▀▀ ▒█▀▀▀█ ▒█▀▀█ ▒█▀▄▀█ ░█▀▀█ ▀▀█▀▀ ▀▀█▀▀ ▀█▀ ▒█▄░▒█ ▒█▀▀█ 
% ▒█▄▄█ ▒█▄▄█ ▒█░▄▄ ▒█▀▀▀ 　 ▒█▀▀▀ ▒█░░▒█ ▒█▄▄▀ ▒█▒█▒█ ▒█▄▄█ ░▒█░░ ░▒█░░ ▒█░ ▒█▒█▒█ ▒█░▄▄ 
% ▒█░░░ ▒█░▒█ ▒█▄▄█ ▒█▄▄▄ 　 ▒█░░░ ▒█▄▄▄█ ▒█░▒█ ▒█░░▒█ ▒█░▒█ ░▒█░░ ░▒█░░ ▄█▄ ▒█░░▀█ ▒█▄▄█

% added these as compiler was complaining about too small margins; doesn't seem to change anything visually, but if compiler is happier, then I'm so too :)
\setlength{\headheight}{14.49998pt}
\addtolength{\topmargin}{-2.49998pt}

% define default paragraph styles
\setlength{\parindent}{0em}
\setlength{\parskip}{1.5ex}

% add sub-sub-sub-section and sub-sub-sub-sub-section commands!
\makeatletter
\newcommand\subsubsubsection{\@startsection{paragraph}{4}{\z@}{-0.5ex\@plus -0ex \@minus -.01ex}{.01ex \@plus .25ex}{\normalfont\normalsize\bfseries}}
\newcommand\subsubsubsubsection{\@startsection{subparagraph}{5}{\z@}{-0.5ex\@plus -0ex \@minus -.01ex}{.01ex \@plus .25ex}{\normalfont\small\bfseries}}
\makeatother

% redefine the default "plain" pagestyle (used by chapter pages)
% only show page number
\fancypagestyle{plain}{
	\fancyhf{} 
	\fancyhead{}
	\fancyfoot[LO,RE]{\sffamily\footnotesize\thepage}
	\renewcommand{\headrulewidth}{0pt}
	\renewcommand{\footrulewidth}{0pt}
}

% define style used for normal pages
% odd pages (aka left) shows chapter marker
% even pages (aka right) shows section name
\fancypagestyle{clean}{
	\fancyhf{}
	\fancyhead[LO]{\sffamily\footnotesize\leftmark}
	\fancyhead[RE]{\sffamily\footnotesize\rightmark}
	\fancyfoot[RE,LO]{\sffamily\footnotesize\thepage}
	\renewcommand{\headrulewidth}{0.1pt}
	\renewcommand{\footrulewidth}{0pt}
}

% define style used for pages where section mark doesn't make sense
% odd and even pages show chapter marker on the outer edge
\fancypagestyle{nosectionmarker}{
	\fancyhf{}
	\fancyhead[RE,LO]{\sffamily\footnotesize\leftmark}
	\fancyfoot[RE,LO]{\sffamily\footnotesize\thepage}
	\renewcommand{\headrulewidth}{0.1pt}
	\renewcommand{\footrulewidth}{0pt}
}

% empty pages before chapters should use empty style (aka nothing)
\let\mtcleardoublepage\cleardoublepage
\renewcommand{\cleardoublepage}{\clearpage{\pagestyle{empty}\mtcleardoublepage}}

% section marker should only use name, without number
\renewcommand{\sectionmark}[1]{\uppercase{\markright{#1}}}

% -------------------------------------------------------------------------
% couple main page formats - used in main tex file where needed; mainly to avoid having to implement this within individual chapter files which would be much less readable and more prone to issues should the order change in the future. But also makes main file more consistent and understandable; even though some of the macros are simple one lines

% format for first couple pages
\newcommand{\SetupPageFormattingTitle}{
	% use empty style for first couple pages (no headers or footers), until defined otherwise
	\pagestyle{empty}
}

\newcommand{\SetupPageFormattingIntro}{
	% LaTeX assumes document starts with an odd page, however in our case the first page is an even page (the right side, then second one will be printed on the back of the same paper). This is how lulu expects it. However, since we use asymmetrical horizontal margins (to accomodate binding), leaving defaults would render the pages the other way ("inner" side where binding is would use smaller margin). It's interesting that only intro pages are affected, TOC and content is fine, even though pages are layed out the same ¯\_(ツ)_/¯ I didn't figure this one out, so am using a hack in manually setting up horizontal margins for intro pages (title is fine, text is right aligned and doesn't wrap so it naturally fits to odd page). However this messes up head rules for content pages which are not rendered the whole width of the page. To compensate we must call `\restoregeometry` before laying out the rest of the document.
	
	% Note: interestingly `\restoregeometry` produces correct results for content pages, even though they are still odd/even in the same "way" as intro pages, not sure why this custom margins are needed here!?

	% Note: we could of course add an empty page in front of the title which would eliminate this whole hacking. But we'd need to remember to remove it from generated PDF before uploading to lulu. And this is something I'm afraid I would too easily forget. The result would be very bad layout in printed book. So I prefer using the hack...

	% Note: the same left/right margin works find for odd and even pages as twopage formatter reverses margins when crossing page boundaries. These margins are larger than the rest of the document, but that's fine as intro pages show very little content.
	\newgeometry{left=3cm,right=2cm}
}

% format for TOC pages, after intro
\newcommand{\SetupPageFormattingTOC}{
	% this prevents empty page from being inserted before TOC (by default LaTeX will start chapters on odd pages which is fine for all pages except TOC - we have acknowlegements here instread)
	\let\cleardoublepage\clearpage

	% restore geometry to the one from `usepacakge` at the top of main file; this is needed to reset custom horizontal marings set for intro pages
	\restoregeometry
	
	% start numbering from 1 with TOC
	\setcounter{page}{1}

	% TOC should only display up to depth 1 (chapter+section)
	\setcounter{tocdepth}{1}

	% use plain page style with just page number for following pages
	\pagestyle{plain}
}

% foramt for the book content pages, after TOC
\newcommand{\SetupPageFormattingBook}{
	% use default page style for all content pages
	\pagestyle{clean}
}

% format for instruction pages
\newcommand{\SetupPageFormattingInstructions}{
	% instruction pages should show chapter name on both odd & even
	\pagestyle{nosectionmarker}
}

\newcommand{\SetupPageFormattingAppendix}{
	% all chapters from hereon should be marked as appendix
	\appendix

	% only print chapters in appendices, not sections and subsections
	\addtocontents{toc}{\protect\setcounter{tocdepth}{0}}
}

% -------------------------------------------------------------------------
% couple commonly used page elements

% creates minitoc without any headers; parameters:
% - (optional) boolean; if star present, no styling will be applied after TOC, otherwise default styling will be applied (which is the default)
\NewDocumentCommand{\ChapterTOC}{ o }{
	\pagestyle{nosectionmarker}

	\etocsettocstyle{}{}	% no title
	\localtableofcontents
	\thispagestyle{plain}	% simple TOC pages without headers
	
	\IfValueF{#1}{\pagestyle{clean}}
}

% we can use this for pages that are intentionally left blank
\newcommand{\IntentionallyEmpty}{
	\mbox{}
	\vfill
	\begin{center}
	This page intentionally left empty
	\end{center}
	\vfill
	\mbox{}
}

% don't stretch content into empty space vertically
\raggedbottom


% ▒█▀▀▀█ ▒█░▒█ ▒█▀▀▀█ ▒█▀▀█ ▀▀█▀▀ ▒█░▒█ ░█▀▀█ ▒█▄░▒█ ▒█▀▀▄ ▒█▀▀▀█ 
% ░▀▀▀▄▄ ▒█▀▀█ ▒█░░▒█ ▒█▄▄▀ ░▒█░░ ▒█▀▀█ ▒█▄▄█ ▒█▒█▒█ ▒█░▒█ ░▀▀▀▄▄ 
% ▒█▄▄▄█ ▒█░▒█ ▒█▄▄▄█ ▒█░▒█ ░▒█░░ ▒█░▒█ ▒█░▒█ ▒█░░▀█ ▒█▄▄▀ ▒█▄▄▄█

% less tall slash
\newcommand\scslash{\stretchrel*{$/$}{\textsc{e}}}

% couple shorthands that can be used throughout the document
\newcommand{\Deg}{\textsuperscript{o}}
\newcommand{\ddd}{\makebox[1em][c]{.\hfil.\hfil.}}
\newcommand{\See}[1]{\textsuperscript{#1}}
\newcommand{\UNDOC}{\textnormal{\textsuperscript{**}}}
\newcommand{\ZXN}{\textnormal{\textsuperscript{ZX}}}
\newcommand{\ZXNS}{\tiny\textnormal{\textsuperscript{ZX}}}
\newcommand{\High}{\textsubscript{h}}
\newcommand{\Low}{\textsubscript{l}}

% instruction flags definitions - for unified formatting
\newcommand{\FS}{$\updownarrow$} % standard effect
\newcommand{\FN}{-}				% no effect
\newcommand{\FU}{?}				% unknown effect
\newcommand{\FX}{$\bullet$}		% special case
\newcommand{\FPV}{VF}			% PV=Overflow
\newcommand{\FPP}{PF}			% PV=Parity

% PortLink is short link to port with description and address, suitable for inline use, while PortReference is longer reference with chapter title and section number mostly used for register lists when referring to previously described register
\newcommand{\PortLink}[2]{{\small \textbf{#1} \MemAddr{#2}}}
\newcommand{\PortReference}[2]{
	\vspace*{-2ex}
	See description under #2 chapter, section \ref{#1}.
}

% other commonly used definitions
\newcommand{\MemAddr}[1]{{\tt \$#1}}


% ▒█▀▀█ ▒█▀▀▀█ ▒█▀▄▀█ ▒█▀▄▀█ ▒█▀▀▀█ ▒█▄░▒█ 　 ▒█▀▀▄ ▒█▀▀█ ░█▀▀█ ▒█░░▒█ ░█▀▀█ ▒█▀▀█ ▒█░░░ ▒█▀▀▀ ▒█▀▀▀█ 
% ▒█░░░ ▒█░░▒█ ▒█▒█▒█ ▒█▒█▒█ ▒█░░▒█ ▒█▒█▒█ 　 ▒█░▒█ ▒█▄▄▀ ▒█▄▄█ ▒█▒█▒█ ▒█▄▄█ ▒█▀▀▄ ▒█░░░ ▒█▀▀▀ ░▀▀▀▄▄ 
% ▒█▄▄█ ▒█▄▄▄█ ▒█░░▒█ ▒█░░▒█ ▒█▄▄▄█ ▒█░░▀█ 　 ▒█▄▄▀ ▒█░▒█ ▒█░▒█ ▒█▄▀▄█ ▒█░▒█ ▒█▄▄█ ▒█▄▄█ ▒█▄▄▄ ▒█▄▄▄█

% horizontal arrows of arbitrary size (lehgth specified through parameter)
\newcommand{\RArrow}[1]{\parbox{#1}{\tikz{
	\draw[->,line width=0.5pt](0,0)--(#1,0);
}}}
\newcommand{\LArrow}[1]{\parbox{#1}{\tikz{
	\draw[<-,line width=0.5pt](0,0)--(#1,0);
}}}

% horizontal arrows with vertical line on the arrow side; parameters:
% - mandatory horizontal line width
% - optional any additional horizontal line styles (dotted, dashed etc)
% - optional vertical line height (divided by 2), default 0.1
% - optional arrow scale, default 1
% - optional line width, default 0.5pt
\NewDocumentCommand{\RArrowLine}{ m O{} O{0.1} O{1.6} O{0.5pt} }{\parbox{#1}{\tikz{
	\draw[-{>[scale=#4,length=#4,width=#4]},line width=#5,#2](0,0)--(#1,0);
	\draw[line width=#5](#1,-#3)--(#1,#3);
}}}
\NewDocumentCommand{\LArrowLine}{ m O{} O{0.1} O{1.6} O{0.5pt} }{\parbox{#1}{\tikz{
	\draw[line width=#5](0,-#3)--(0,#3);
	\draw[-{>[scale=#4,length=#4,width=#4]},line width=#5,#2](#1,0)--(0,0);
}}}


% ▒█▀▀█ ▒█░▒█ ▒█▀▀▀█ ▀▀█▀▀ ▒█▀▀▀█ ▒█▀▄▀█ ▀█▀ ▒█▀▀▀█ ░█▀▀█ ▀▀█▀▀ ▀█▀ ▒█▀▀▀█ ▒█▄░▒█ ▒█▀▀▀█ 
% ▒█░░░ ▒█░▒█ ░▀▀▀▄▄ ░▒█░░ ▒█░░▒█ ▒█▒█▒█ ▒█░ ░▄▄▄▀▀ ▒█▄▄█ ░▒█░░ ▒█░ ▒█░░▒█ ▒█▒█▒█ ░▀▀▀▄▄ 
% ▒█▄▄█ ░▀▄▄▀ ▒█▄▄▄█ ░▒█░░ ▒█▄▄▄█ ▒█░░▒█ ▄█▄ ▒█▄▄▄█ ▒█░▒█ ░▒█░░ ▄█▄ ▒█▄▄▄█ ▒█░░▀█ ▒█▄▄▄█

% define the style for lstlisting
\lstdefinestyle{CodeStyle}{
	basicstyle=\ttfamily\small,
	commentstyle=\color{PrintableDarkGray},
	columns=flexible,
	tabsize=4,
	numbers=left,
	numberstyle=\ttfamily\tiny,
	numbersep=1.8em,
	morecomment=[l]{;},
	moredelim=[is][\rmfamily\itshape]{|}{|},	% any text within |...| will be roman/italic
	literate={&}{\$}1							% replace `&` with `$` (to avoid syntax higlight issues)
			{Band}{\&~}1						% replace `Band` with `&` (to allow bitwise and output without & being consumed for $ from previous rule)
			{Bor}{|~}1							% replace `Bor' with `|` (to allow bitwise or output without | being consumed for roman/italic from moredelim rule above)
}

% define default settings for all tcolorbox instances
\tcbset{
	arc=4pt,			% radius for rounded corners
	boxrule=0pt,		% no frame around the box
	boxsep=1.3ex,		% add some spacing between frame and content
	left=0ex,			% left side should be flush with content
	right=0ex,			% right side should be flush with content
	top=-1.5ex,			% less spacing between frame and start of content
	bottom=-1.5ex,		% less spacing between end of content and frame
	pad at break=1pt,	% leave some small spacing between content and frame when page break occurs
	before skip=2ex,
	after skip=3ex,
	colback=PrintableLightGray,
	colframe=PrintableLightGray,
	enhanced,			% only use rounded corners on top and bottom part, not between page breaks
	breakable,			% allow breaking tcolorbox to multiple pages
	listing only,		% only show listing
	listing options={style=CodeStyle},
}
